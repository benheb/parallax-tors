$(document).ready(function(){var a=$(window).height()+20;$(".maps").css({width:$(window).width()+"px",height:a+100+"px"}),$(".about").css("height",a+40+"px"),$(".map-blurb").css("height",a+40+"px"),$("#home").css("height",a+"px"),$("#intro-map").css({width:$(window).width()+"px",height:$(window).height()+100+"px"}),$("#header").on("mouseover",function(){$("#header-inner").slideDown("fast",function(){$("#credit").show()})}),$(".scrollblock").on("mouseover",function(){$("#credit").hide(),$("#header-inner").slideUp("fast")}),app=new torApp});var torApp=function(){this.intro(),this.createMap(),this.addLand(),this.scrollControls(),this.updateLegend(),this.scrollSetup()};torApp.prototype.scrollControls=function(){var a=this,b=$(window).height()+20;$(document).width(),$(window).on("resize",function(){var b=$(window).height(),c=$(window).width();$(".about").css("height",b+100+"px"),$("#home").css("height",b+"px"),$("#intro-map").css({width:c+"px",height:b+100+"px"}),a.intro_svg.attr("width",c).attr("height",b+100)}),$("#map-controls").css("top",b-55+"px"),$("#toggle-paths").on("click",function(){a.drawLines(null,a.active)}),$("#next-section").on("click",function(){var b=$(window).height()+51;$(window).scrollTop();var c=a.active,d={map_one:2,map_two:3,map_three:4,map_four:5,map_five:6,map_six:7,map_seven:8,map_eight:8};$("body,html").animate({scrollTop:b*d[c]},2e3)}),$window=$(window);var c=$("#home");$("#intro-map-window .inner.wbg"),$(window).scroll(function(){if(!$("body").hasClass("no-scroll")){var d=$(window).scrollTop();this.prev_pos||(this.prev_pos=d),d>10?(setTimeout(function(){$("#map-controls").fadeIn()},300),$("#intro-map").fadeOut(),$("#intro-map-window-one").fadeOut(),$("#intro-map-window-two").show(),$("#scroll-tip-container").hide()):($("#map-controls").hide(),$("#intro-map-window-two").hide(),$("#intro-map").fadeIn(),$("#intro-map-window-one").show(),$("#scroll-tip-container").show()),3>d&&this.prev_pos>3&&(a.intro_svg.selectAll(".intro-tors").transition().duration(1e3).attr("transform",function(b){var c=Math.floor(20*Math.random()+1),d=parseFloat(b.latitude)+c;return"translate("+a.intro_projection([b.longitude,d])+")"}).transition().duration(1e3).delay(function(){return Math.floor(700*Math.random()+50)}).ease("bounce").attr("transform",function(b){return"translate("+a.intro_projection([b.longitude,b.latitude])+")"}),$(".about").removeClass("viewed"),a.RemovePoints()),10>d?$(".intro-diddy").css("position","absolute"):d>b?$(".intro-diddy").css("position","relative"):$(".intro-diddy").css("position","fixed"),this.prev_pos=d,clearTimeout($.data(this,"scrollTimer")),$.data(this,"scrollTimer",setTimeout(function(){$(".maps").css({"pointer-events":"auto"})},1200));var e=-($window.scrollTop()/c.data("speed")),f="50% "+e+"px";$(c).hasClass("map_two")||c.css({backgroundPosition:f})}}),$(".about").appear(),$(".about").on("appear",function(){var b=$(this).children(".maps").attr("id");a.active=b,a.playVideo(b),a.LoadPoints(b),$(this).addClass("viewed")}),$(".about").on("disappear",function(){$(this).removeClass("viewed");var b=$(this).attr("id");a.stopVideo(b)}),$(".pendulum").on("mouseover",function(){$("#scroll-helper").fadeIn("slow")}).on("mouseout",function(){$("#scroll-helper").fadeOut("slow")}),$("#outro").css("height",b-150+"px")},torApp.prototype.createMap=function(){var a=this,b=1e3,c=$(document).width();this.maps={map_one:{id:"map_one",projection:d3.geo.albers().scale(1.4*c).center([17,33]).clipAngle(90).translate([c/2,b/2]),dataset:"data/may-24-26-2011.csv"},map_two:{id:"map_two",projection:d3.geo.mercator().scale(2.2*c).center([-95,33]).translate([c/2,b/2]).precision(.1),dataset:"data/feb-5-6-2008.csv"},map_three:{id:"map_three",projection:d3.geo.mercator().scale(2.2*c).center([-90,39]).translate([c/2,b/2]).precision(.1),dataset:"data/may-22-2011.csv"},map_four:{id:"map_four",projection:d3.geo.albers().scale(2.9*c).center([6,34]).translate([c/2,b/2]),dataset:"data/may-3-1999.csv"},map_five:{id:"map_five",projection:d3.geo.albers().scale(1.4*c).center([20,33]).translate([c/2,b/2]),dataset:"data/nov-21-23-1992.csv"},map_six:{id:"map_six",projection:d3.geo.orthographic().scale(1.5*c).translate([c/2,b/2]).clipAngle(90).rotate([96,-33]).precision(.1),dataset:"data/apr-11-12-1965.csv"},map_seven:{id:"map_seven",projection:d3.geo.albers().scale(1.5*c).center([20,32]).translate([c/2,b/2]),dataset:"data/apr-3-4-1974.csv"},map_eight:{id:"map_eight",projection:d3.geo.albers().scale(1.4*c).center([20,31]).translate([c/2,b/2]),dataset:"data/apr-26-27-28-2011.csv"}},this.projection=d3.geo.albers().scale(1700).center([20,33]).clipAngle(90).translate([c/2,b/2]),this.path=d3.geo.path().projection(this.projection),$.each(this.maps,function(b,c){var d=c.id;a[d]=d3.select("#"+d).append("svg").attr("class","map-svg")}),this.legend=d3.select("#legend").append("svg"),this.scales={0:3,1:5,2:7,3:11,4:14,5:19}},torApp.prototype.addLand=function(){var a=this;d3.json("data/usa-detail.json",function(b,c){$.each(a.maps,function(b,d){d.projection;var e=d3.geo.path().projection(d.projection),f=d.id;"map_two"!==f&&"map_three"!==f&&"map_four"!==f?(a[f].append("g").attr("class","states").selectAll("path").data(topojson.feature(c,c.objects["usa-states"]).features).enter().append("path").attr("class","states").attr("id",d+"_states").attr("d",function(b){a.addLabel(b,f)}).attr("d",e),a[f].insert("path").datum(topojson.feature(c,c.objects.ne_50m_lakes)).attr("class","lakes").attr("d",e)):"map_two"===f?a[f].append("g").attr("class","states").selectAll("path").data(topojson.feature(c,c.objects["usa-states"]).features).enter().append("path").attr("id",function(a){return a.id}).attr("class",function(b){return"Texas"===b.properties.NAME||"Kentucky"===b.properties.NAME||"Louisiana"===b.properties.NAME||"Arkansas"===b.properties.NAME||"Tennessee"===b.properties.NAME||"Alabama"===b.properties.NAME||"Mississippi"===b.properties.NAME||"Missouri"===b.properties.NAME||"Indiana"===b.properties.NAME||"Illinois"===b.properties.NAME?(a.addLabel(b,f),"states-partial"):"states-hidden"}).attr("d",e):"map_three"===f?a[f].append("g").attr("class","states").selectAll("path").data(topojson.feature(c,c.objects["usa-states"]).features).enter().append("path").attr("id",function(a){return a.id}).attr("class",function(b){return"Oklahoma"===b.properties.NAME||"Kansas"===b.properties.NAME||"Iowa"===b.properties.NAME||"Wisconsin"===b.properties.NAME||"Minnesota"===b.properties.NAME||"Missouri"===b.properties.NAME||"Indiana"===b.properties.NAME||"Illinois"===b.properties.NAME?(a.addLabel(b,f),"states-partial"):"states-hidden"}).attr("d",e):"map_four"===f&&a[f].append("g").attr("class","states").selectAll("path").data(topojson.feature(c,c.objects["usa-states"]).features).enter().append("path").attr("id",function(a){return a.id}).attr("class",function(b){return"Texas"===b.properties.NAME||"Oklahoma"===b.properties.NAME||"Kansas"===b.properties.NAME||"Nebraska"===b.properties.NAME?(a.addLabel(b,f),"states-partial"):"states-faded"}).attr("d",e)})})},torApp.prototype.addLabel=function(a,b){this.maps[b].projection;var c=d3.geo.path().projection(this.maps[b].projection);this[b].append("text").attr("class","subunit-label").attr("transform",function(){return"translate("+c.centroid(a)+")"}).attr("dy",".35em").text(function(){return a.properties.NAME}),this[b].selectAll(".place-label").attr("x",function(a){return a.geometry.coordinates[0]>-1?6:-6}).style("text-anchor",function(a){return a.geometry.coordinates[0]>-1?"start":"end"})},torApp.prototype.updateLegend=function(){var a=this.legend.append("g"),b=[{radius:3,x:5,y:20},{radius:5,x:50,y:20},{radius:7,x:100,y:20},{radius:10,x:160,y:20},{radius:14,x:230,y:20},{radius:19,x:300,y:20}];a.selectAll("circle").data(b).enter().insert("circle").attr("transform",function(a){return"translate("+a.x+","+a.y+")"}).attr("fill","rgb(39, 127, 238)").attr("stroke","rgb(254, 230, 206)").attr("stroke-width",.8).attr("opacity",.8).attr("class","legend-dots").attr("r",function(a){return a.radius})},torApp.prototype.LoadPoints=function(a){var b=this;$(document).width(),$("#"+a+"_graphic").length||d3.csv(this.maps[a].dataset).row(function(a){return{date:a.Date,scale:a.Fujita,county:a.County1,state:a.State1,latitude:a.TouchdownLat,longitude:a.TouchdownLon,damages:a.Damage,endLat:a.LiftoffLat,endLon:a.LiftoffLon,injuries:a.Injuries,fatalities:a.Fatalities}}).get(function(c,d){var e=0,f=0;$("#tornado-count .count").html(d.length);var g=b.maps[a].projection,h=b[a].append("g");h.selectAll("circle").data(d).enter().insert("circle").attr("transform",function(b){var c;"map_eight"===a?(c=Math.floor(200*Math.random())+1,c*=1==Math.floor(2*Math.random())?1:-1):c=0;var d=parseFloat(b.latitude)+c,e=parseFloat(b.longitude)+c;return"translate("+g([e,d])+")"}).attr("fill","rgb(39, 127, 238)").attr("stroke","rgb(254, 230, 206)").attr("radius",0).attr("opacity",0).attr("class","storm-reports").attr("id",a+"_graphic").on("mouseover",function(c){window.clearTimeout(b.infoTimeout),d3.select(this).attr("d",b.hover(c,a)).transition().duration(400).attr("opacity",.1).attr("r",function(){var a=void 0==c.scale?0:b.scales[c.scale]+14;return a-2}).transition().duration(400).attr("opacity",.8).attr("r",function(){var a=void 0==c.scale?0:b.scales[c.scale];return a-2})}).on("mouseout",function(){b.infoTimeout=window.setTimeout(function(){$("#info-window").fadeOut(),d3.selectAll(".tor-path").remove()},1500)}).transition().delay(function(){return Math.floor(1200*Math.random())}).duration(1e3).attr("stroke-width",function(a){return"Newton"===a.county&&5===parseFloat(a.scale)||"Grady"===a.county&&5===parseFloat(a.scale)?3:.9}).attr("opacity",.8).attr("d",function(a){e+=parseInt(a.injuries),f++}).attr("r",function(a){var c=void 0==a.scale?0:b.scales[a.scale];return c-2}).transition().duration(4100).attr("transform",function(a){return"translate("+g([a.longitude,a.latitude])+")"}),$("."+a+" .injured-by-tors .number").html(e),$("."+a+" .number-of-tors .number").html(f)})},torApp.prototype.drawLines=function(a,b){var c=this;d3.selectAll(".tor-path").remove();var d=c[b].append("g"),e=c.maps[b].projection;a?"-"!=a.endLat&&d.selectAll("line").data([a]).enter().append("line").style("stroke","rgb(254, 230, 206)").style("stroke-width",1.3).attr("class","tor-path tornado-paths-"+b).attr("x1",e([a.longitude,a.latitude])[0]).attr("y1",e([a.longitude,a.latitude])[1]).attr("x2",e([a.longitude,a.latitude])[0]).attr("y2",e([a.longitude,a.latitude])[1]).transition().duration(2e3).attr("x2",e([a.endLon,a.endLat])[0]).attr("y2",e([a.endLon,a.endLat])[1]):d3.csv(this.maps[b].dataset).row(function(a){return{date:a.Date,scale:a.Fujita,county:a.County1,state:a.State1,latitude:a.TouchdownLat,longitude:a.TouchdownLon,damages:a.Damage,endLat:a.LiftoffLat,endLon:a.LiftoffLon,injuries:a.Injuries,fatalities:a.Fatalities}}).get(function(a,c){d.selectAll("line").data(c).enter().insert("line").style("stroke","rgb(254, 230, 206)").style("stroke-width",1.3).attr("class","tor-path tornado-paths-"+b).attr("x1",function(a){return"-"!=a.endLat?e([a.longitude,a.latitude])[0]:void 0}).attr("y1",function(a){return"-"!=a.endLat?e([a.longitude,a.latitude])[1]:void 0}).attr("x2",function(a){return"-"!=a.endLat?e([a.longitude,a.latitude])[0]:void 0}).attr("y2",function(a){return"-"!=a.endLat?e([a.longitude,a.latitude])[1]:void 0}).transition().duration(2e3).attr("x2",function(a){return"-"!=a.endLat?e([a.endLon,a.endLat])[0]:void 0}).attr("y2",function(a){return"-"!=a.endLat?e([a.endLon,a.endLat])[1]:void 0})})},torApp.prototype.RemovePoints=function(){$(".storm-reports").remove()},torApp.prototype.hover=function(a,b){this.exit(),this.drawLines(a,b);var c=this.maps[b].projection([a.longitude,a.latitude])[0]-84,d=this.maps[b].projection([a.longitude,a.latitude])[1]-145,e='<div id="info-window"></div>';$("#"+b).append(e);var f=a.damages?a.damages:"n/a",g="    <span>Rating: "+a.scale+"</span><br />    <span>Injuries: "+a.injuries+"</span><br />    <span>Fatalities: "+a.fatalities+"</span><br />    <span>Date: "+a.date+"</span><br />    <span>"+a.county+", "+a.state+"</span><br />    <span>Damages: "+f+"</span><br />";$("#info-window").html(g).css({left:c+"px",top:d+"px"}).delay(500).fadeIn(1e3);var h=this.maps[b],i=d3.geo.path().projection(h.projection);app[h.id].selectAll("path").attr("d",i)},torApp.prototype.exit=function(){d3.selectAll(".hover").transition().style("fill-opacity",0).duration(2e3).remove(),d3.selectAll(".tip-line").transition().style("stroke-opacity",0).duration(900).remove(),$("#info-window").fadeOut(600),$("#info-window").remove()},torApp.prototype.playVideo=function(a){var b=a.replace(/map_/g,""),c=document.getElementById("video-"+b+"-canvas");if(c){var d=c.getContext("2d"),e=document.getElementById("video-"+b);e.addEventListener("play",function(){var a=this,b=e.videoWidth/e.videoHeight,f=e.videoWidth-50,g=parseInt(f/b,10);c.width=f,c.height=g,d.width=f,d.height=g,function h(){a.paused||a.ended||(d.drawImage(a,10,10),setTimeout(h,1e3/60))}()},0),e.play(),e.volume=.2}},torApp.prototype.stopVideo=function(a){if(a){var b=a.replace(/section-/g,""),c=document.getElementById("video-"+b);c&&c.pause()}},torApp.prototype.intro=function(){function a(){$("#loading").hide(),f.intro_svg.transition().duration(7e3).style("opacity",1).tween("projection",function(){return function(a){j.alpha(a),f.intro_svg.selectAll("path").attr("d",k)}}).each("end",c)}function b(a,b){function c(c,e){var f=a([c*=180/Math.PI,e*=180/Math.PI]),g=b([c,e]);return[(1-d)*f[0]+d*g[0],(d-1)*f[1]-d*g[1]]}var d,e=d3.geo.projection(c).scale(1),f=e.center,g=e.translate;return e.alpha=function(c){if(!arguments.length)return d;d=+c;var h=a.center(),i=b.center(),j=a.translate(),k=b.translate();return f([(1-d)*h[0]+d*i[0],(1-d)*h[1]+d*i[1]]),g([(1-d)*j[0]+d*k[0],(1-d)*j[1]+d*k[1]]),e},delete e.scale,delete e.translate,delete e.center,e.alpha(0)}function c(){var a={0:1,1:1,2:1.5,3:2,4:3,5:4};d3.csv("data/apr-26-27-28-2011.csv").row(function(a){return{date:a.Date,scale:a.Fujita,county:a.County1,state:a.State1,latitude:a.TouchdownLat,longitude:a.TouchdownLon,damages:a.Damage,injuries:a.Injuries,fatalities:a.Fatalities}}).get(function(b,c){var e=f.intro_svg.append("g");f.intro_projection=j;var g;e.selectAll("circle").data(c).enter().insert("circle").attr("transform",function(a){var b=Math.floor(100*Math.random()+1);g=Math.floor(6e3*Math.random()+1);var c=parseFloat(a.latitude)+b;return"translate("+j([a.longitude,c])+")"}).attr("fill","rgb(39, 127, 238)").attr("stroke","rgb(254, 230, 206)").attr("stroke-width",.8).attr("opacity",0).attr("class","intro-tors").attr("r",function(b){var c=void 0==b.scale?1:a[b.scale]+2;return c}).transition().delay(function(){return Math.floor(4e3*Math.random()+300)}).duration(3e3).attr("transform",function(a){return"translate("+j([a.longitude,a.latitude])+")"}).attr("opacity",.5),d()})}function d(a){if(!a)var a=0;var b=.35*$(window).height(),c=b+191,g=[[{x1:$(document).width()/2,y1:0},{x2:$(document).width()/2,y2:b}],[{x1:$(document).width()/2,y1:b},{x2:$(document).width()/2+436,y2:b}],[{x1:$(document).width()/2+436,y1:b},{x2:$(document).width()/2+436,y2:c}],[{x1:$(document).width()/2+436,y1:c},{x2:$(document).width()/2-435,y2:c}],[{x1:$(document).width()/2-435,y1:c},{x2:$(document).width()/2-435,y2:b}],[{x1:$(document).width()/2-435,y1:b},{x2:$(document).width()/2,y2:b}]];return a>=g.length?(e(),void 0):(f.intro_svg.append("line").attr("stroke","#CCC").attr("stroke-width",2).attr("class","intro-lines").attr("x1",g[a][0].x1).attr("y1",g[a][0].y1).attr("x2",g[a][0].x1).attr("y2",g[a][0].y1).transition().duration(500).attr("x2",g[a][1].x2).attr("y2",g[a][1].y2).each("end",function(){a++,d(a)}),void 0)}function e(){$("body").removeClass("no-scroll"),$("#intro-map-window-one").fadeIn(function(){$(".intro-lines").fadeOut("slow")}),$("#scroll-tip-container").show()}var f=this,g=$(window).width(),h=$(window).height(),i=g/4,j=b(d3.geo.orthographic().rotate([10,-10]).center([-10,10]).scale(i+40).translate([g/2,h/2]),d3.geo.equirectangular().scale(i-30).translate([g/2,h/2])),k=d3.geo.path().projection(j),l=d3.geo.graticule();this.intro_svg=d3.select("#intro-map").append("svg").style("opacity",0).attr("width",g).attr("height",h),this.intro_svg.append("path").datum({type:"Sphere"}).attr("class","sphere").attr("d",k),this.intro_svg.append("path").datum(l).attr("class","graticule").attr("d",k),d3.json("data/world.json",function(b,c){f.intro_svg.insert("path",".graticule").datum(topojson.feature(c,c.objects.world)).attr("class","intro-land").attr("d",k),a()})},torApp.prototype.scrollSetup=function(){var a=$.scrollorama({blocks:".scrollblock",enablePin:!1}),b=$(window).height(),c=$(window).width();a.animate("#map_one_title",{delay:100,duration:500,property:"left",start:-600,end:-4}),a.animate("#section-two",{duration:300,property:"opacity",start:0,end:1}),a.animate("#map_two_title",{delay:150,duration:500,property:"right",start:-600,end:-2}),a.animate("#map_three_title",{delay:150,duration:500,property:"left",start:-500,end:-2}),a.animate("#joplin-about",{delay:650,duration:100,property:"height",start:0,end:385}),a.animate("#section-four",{duration:b,property:"top",start:0,end:0}),a.animate("#map_four_title",{delay:150,duration:500,property:"left",start:-500,end:-2}),a.animate("#map_five_title",{delay:100,duration:500,property:"left",start:-600,end:-4}),a.animate("#blurb-six",{delay:180,duration:550,property:"opacity",start:0,end:.8}),a.animate("#map_six_title",{delay:350,duration:500,property:"right",start:-500,end:-2}),a.animate("#map_seven_title",{duration:400,property:"top",start:-100,end:0}),a.animate("#seven-image-1",{delay:100,duration:600,property:"top",start:-b,end:190}),a.animate("#seven-image-1",{delay:100,duration:600,property:"left",start:c,end:-50}),a.animate("#seven-image-2",{delay:100,duration:700,property:"top",start:-500,end:200}),a.animate("#seven-image-2",{delay:100,duration:600,property:"left",start:-1200,end:120}),a.animate("#seven-image-3",{delay:150,duration:600,property:"top",start:b,end:325}),a.animate("#seven-image-3",{delay:150,duration:600,property:"left",start:-930,end:-135}),a.animate("#seven-image-4",{delay:150,duration:600,property:"top",start:-1e3,end:390}),a.animate("#seven-image-4",{delay:150,duration:600,property:"left",start:400,end:153}),a.animate("#seven-image-6",{delay:250,duration:500,property:"top",start:-900,end:526}),a.animate("#seven-image-6",{delay:250,duration:500,property:"left",start:400,end:-20}),a.animate("#eight-info",{delay:250,duration:500,property:"line-height",start:0,end:2.7}),a.animate("#map_eight_title",{delay:100,duration:500,property:"left",start:-600,end:-4}),a.animate("#footer",{delay:b-250,duration:120,property:"bottom",start:-300,end:0})};